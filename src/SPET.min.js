/*** 
 * @fileOverview Syncapse Platform Event Track
 * @author syncapseUK@syncapse.comts.
 * @see https://github.com/syncapse-developers/syncapse-event-track 
 * @copyright Syncapse
 * @license For use by clients of Syncapse and their agencies. Sorry, this code is not Free/Open Source :(
 *//**
 * Syncapse Platform Event Track 1.1
 * 
 * Event track is a system for tracking events in Facebook Tabs and Applications.  
 * These actions are tracked using a client-side library and recorded within the Syncapse Platform. 
 * Clients with access to the Measure product within the Syncapse Platform can run reports on the tracked events.
 * 
 * 
 * @class Represents the Syncapse Platform Event Tracker
 * @param {String} source The URL of the App/Tab that is being tracked
 * @param {String} [session] The current session
 * @param {Object} [params] any parameters to be passed to the "page-view" event (also can include debug: true)
 * @param {Boolean} [params.debug="true"] If debug is true, no data will be sent to the Syncapse tracking server. Instead, all tracking event data will be output to the browser console using console.log.
 * @param {String} [params.trackDomain="track.platform.syncapse.com"] The tracking domain to which the Event Track class will send event data.
 * @param {String} [params.trackPath="/track.gif"] The path component for the tracking image.
 * @param {String} [params.location="document.location.href"] A 'location' data element to send to the server.
 * @param {String} [params.fromVariableName="from"] Event Track can track where a user has arrived from by using a named GET variable.
 * @param {Boolean} [params.inFbml="false"] If you are using Event Track in an FBML context (which is officially unsupported), you may want to set the parameter to 'true'.
 * @param {String} [params.imageId="spet_image"] If you are using Event Track in an FBML context (officially unsupported), Event Track needs a DOM image element with this ID.
 * @param {Boolean} [params.skipOnLoadEvent="false"] Event Track will fire a 'page-view' event automatically in the constructor. If this is not your desired behaviour, set this parameter to 'true'.
 * 
 * @returns {SPET} An instance of the Syncapse Platform Event Tracker.
 */function SPET(a,b,c){this.debug=typeof c.debug!="undefined"&&c.debug!==!1,delete c.debug;if(typeof a=="undefined"||!a)throw new Error("You must pass a source URL string to the SPET constructor");b=b||this.generateSession(),this.source=a,this.session=b,c=c||this.getDefaultParams(),c.client="SPET JavaScript/1.1",this.trackDomain=c.trackDomain||"track.platform.syncapse.com",c.location=c.location||document.location.href,c=this.addQueryVars(c,document.location.search?document.location.search.substring(1):"");var d=c.fromVariableName||"from";c.from=c["get_"+d],this.inFbml=typeof c.inFbml!="undefined"&&c.inFbml||typeof Image=="undefined",this.imageId=c.imageId||"spet_image",this.trackPath=c.trackPath=c.trackPath||"/track.gif",this.baseParams=c,c.skipOnLoadEvent=typeof c.skipOnLoadEvent!="undefined"&&c.skipOnLoadEvent,!this.inFbml&&!c.skipOnLoadEvent&&this.track("page-view",c)}SPET.prototype.addQueryVars=function(a,b,c){var d=this.getQueryParams(b);c=c||"get_";for(var e in d)a[c+e]=d[e];return a},SPET.prototype.getDefaultParams=function(){return{location:document.location.href,debug:!0,skipOnLoadEvent:!1,inFbml:!1}},SPET.prototype.getSession=function(){return this.session},SPET.prototype.generateSession=function(){var a=(new Date).getTime(),b=Math.floor(Math.random()*1e7);return a+"-"+b},SPET.prototype.getUrl=function(){var a="http";try{document.location.protocol==="https:"&&(a="https")}catch(b){}return a+"://"+this.trackDomain+this.trackPath},SPET.prototype.getQueryParams=function(a){var b={},c=a.split("&"),d;for(var e=0;e<c.length;e++)d=c[e].split("="),b[d[0]]=d[1]?d[1]:"";return b},SPET.prototype.buildQueryString=function(a){if(this.inFbml)return this.buildFbmlQueryString(a);var b="?",c;for(c in a)typeof a[c]!="function"&&(b.length>1&&(b+="&"),b+=encodeURIComponent(c)+"="+encodeURIComponent(""+a[c]));return b.replace(/%20/g,"+")},SPET.prototype.buildFbmlQueryString=function(a){var b=[];for(var c in a){if(typeof a[c]=="function")continue;var d=a[c]+"";d=="null"&&(d=""),d=="undefined"&&(d=""),b.push(escape(c)+"="+escape(a[c]))}return"?"+b.join("&")},SPET.prototype.log=function(a,b){b=b||{},console.log&&console.log(a,b)},SPET.prototype.track=function(a,b){try{b=b||{},b.se=this.session,b.so=this.source,b.ev=a,b.r=Math.floor(Math.random()*1e7),b=this.extend({},this.baseParams,b);var c=["trackPath","trackDomain","skipOnLoadEvent"];for(var d in c)delete b[c[d]];var e=this.getUrl()+this.buildQueryString(b);this.debug?(b.trackUrl=e,this.log(a,b)):this.setImageSource(e)}catch(f){this.log("error-lib",{error:""+f})}return!0},SPET.prototype.setImageSource=function(a){if(!this.inFbml){try{var b=new Image;b.src=a}catch(c){this.log("error-lib",{error:""+c})}return}var d=document.getElementById(this.imageId);if(!d){var c="Cannot find Image element with id '"+this.imageId+"'. You must embed an Image element into your FBML page.";this.log("error-lib",{error:""+c});return}try{d.setSrc(a)}catch(c){this.log("error-lib",{error:""+c})}},SPET.prototype.attachListeners=function(a){if(typeof $=="undefined")return;var b=this;$(a).find('a[track!="false"]').mousedown(function(){b.trackElement(this)}),$(a).find('form[track!="false"]').submit(function(){b.trackElement(this)})},SPET.prototype.attachFBListeners=function(){if(typeof FB=="undefined")return;var a=this;try{FB.Event.subscribe("comment.create",function(b){a.track("comment-create")}),FB.Event.subscribe("comment.remove",function(b){a.track("comment-remove")}),FB.Event.subscribe("edge.create",function(b){a.track("like-create",{target:b})}),FB.Event.subscribe("edge.remove",function(b){a.track("like-remove",{target:b})}),FB.Event.subscribe("auth.authResponseChange",function(b){b.status=="connected"?a.track("facebook-login",{facebook_uid:b.authResponse.userID}):b.status=="unknown"&&a.track("facebook-logout")})}catch(b){a.track("error-facebook",{error:b.toString()})}},SPET.prototype.attachFbListeners=function(){return this.attachFBListeners()},SPET.prototype.trackElement=function(a){if(typeof $=="undefined")return;var b=a.tagName.toLowerCase(),c=b==="form"?"form-submit":"link-click",d=$(a);d.attr("track")&&(c=d.attr("track"));var e={element:b};return d.attr("href")&&(e.url=d.attr("href")),b==="form"&&(d.attr("action")&&(e.url=d.attr("action")),e.data=$(a).serialize()),this.track(c,e)},SPET.prototype.extend=function(a,b){if(arguments.length>2)for(var c=1;c<arguments.length;c++)this.extend(a,arguments[c]);else for(var d in b)a[d]=b[d];return a}